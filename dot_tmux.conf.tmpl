set -g default-command {{ if (eq .chezmoi.hostname "px-1021") }}zsh{{ else if (eq .chezmoi.hostname "visu01") }}/home/ad/berthiv/.local/bin/zsh{{ else }}/usr/bin/zsh{{ end }}

set -g mouse on
set -g prefix C-a
set-option -g allow-rename off

# Use ctrl+a as prefix instead of ctrl+b
unbind C-b
bind-key C-a send-prefix

# VI mode
set-window-option -g mode-keys vi
unbind -T copy-mode-vi Space;
unbind -T copy-mode-vi Enter;
unbind -T copy-mode-vi h;
unbind -T copy-mode-vi j;
unbind -T copy-mode-vi k;
unbind -T copy-mode-vi l;
unbind -T copy-mode-vi H;
unbind -T copy-mode-vi J;
unbind -T copy-mode-vi K;
unbind -T copy-mode-vi L;

bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "xsel --clipboard"
bind-key    -T copy-mode-vi t                    send-keys -X cursor-left
bind-key    -T copy-mode-vi s                    send-keys -X cursor-down
bind-key    -T copy-mode-vi r                    send-keys -X cursor-up
bind-key    -T copy-mode-vi n                    send-keys -X cursor-right
bind-key    -T copy-mode-vi l                    send-keys -X search-again
bind-key    -T copy-mode-vi L                    send-keys -X search-reverse
bind-key    -T copy-mode-vi v                    send-keys -X begin-selection
bind-key    -T copy-mode-vi T                    send-keys -X top-line
bind-key    -T copy-mode-vi S                    send-keys -X scroll-down
bind-key    -T copy-mode-vi R                    send-keys -X scroll-up
bind-key    -T copy-mode-vi N                    send-keys -X bottom-line

# smart pane switching with awareness of vim splits
bind -n C-t run "(tmux display-message -p '#{pane_current_command}' | grep -iq vim && tmux send-keys C-h) || tmux select-pane -L"
bind -n C-s run "(tmux display-message -p '#{pane_current_command}' | grep -iq vim && tmux send-keys C-j) || tmux select-pane -D"
bind -n C-r run "(tmux display-message -p '#{pane_current_command}' | grep -iq vim && tmux send-keys C-k) || tmux select-pane -U"
bind -n C-n run "(tmux display-message -p '#{pane_current_command}' | grep -iq vim && tmux send-keys C-l) || tmux select-pane -R"
# bind -n C-\ run "(tmux display-message -p '#{pane_current_command}' | grep -iq vim && tmux send-keys 'C-\\') || tmux select-pane -l"

# Change binds for splits
unbind %
bind | split-window -h -c "#{pane_current_path}"

unbind '"'
bind - split-window -v -c "#{pane_current_path}"

# Hide status bar on demand
bind C-s if -F '#{s/off//:status}' 'set status off' 'set status on'

# sessions
bind Q confirm-before -p "Kill-session #S? (y/n)" kill-session
bind d detach
bind M-v choose-tree -Zs
bind M-V choose-tree -Zw

# Windows
set -g base-index 1
set-window-option -g pane-base-index 1
unbind n
unbind p
bind -n M-s previous-window
bind -n M-r next-window
bind -n M-c command-prompt -I "#W" { rename-window "%%" }
bind X kill-window
bind C-x confirm-before -p "Kill other windows? (y/n)" "kill-window -a"

# Panes
bind -r t resize-pane -L 5
bind -r s resize-pane -D 5
bind -r r resize-pane -U 5
bind -r n resize-pane -R 5
bind -r m resize-pane -Z  # toggle pane maximized

bind-key -T copy-mode-vi 'C-t' select-pane -L
bind-key -T copy-mode-vi 'C-s' select-pane -D
bind-key -T copy-mode-vi 'C-r' select-pane -U
bind-key -T copy-mode-vi 'C-n' select-pane -R

bind x kill-pane

######### Plugins
set -g @plugin "tmux-plugins/tpm"

# list of plugins
#set -g @plugin "arcticicestudio/nord-tmux"
set -g @plugin "catppuccin/tmux"
set -g @plugin "christoomey/vim-tmux-navigator"
set -g @plugin 'tmux-plugins/tmux-resurrect' # persist tmux sessions after computer restart
set -g @plugin 'tmux-plugins/tmux-continuum' # auto-save sessions every 15 minutes
set -g @plugin 'tmux-plugins/tmux-prefix-highlight'
set -g @plugin 'tmux-plugins/tmux-sidebar'  # Sidebar, prefix + tab or prefix + backspace
set -g @plugin 'tmux-plugins/tmux-online-status'
set -g @plugin 'samoshkin/tmux-plugin-sysstat'
# set -g @themepack "powerline/double/blue"
set -g @catppuccin_flavour "mocha"
set -g @catppuccin_window_tabs_enabled on # or off to disable window_tabs

set -g @resurrect-capture-pane-contents 'on'
set -g @continuum-restore 'on'

bind M-r source-file ~/.tmux.conf \; display "Reloaded ~/.tmux.conf"

# tmux-sensible options
# Address vim mode switching delay (http://superuser.com/a/252717/65504)
set -s escape-time 0

# Increase scrollback buffer size from 2000 to 50000 lines
set -g history-limit 50000

# Increase tmux messages display duration from 750ms to 4s
set -g display-time 2000

# Refresh 'status-left' and 'status-right' more often, from every 15s to 5s
set -g status-interval 5

# Upgrade $TERM
set -g default-terminal "screen-256color"

# Focus events enabled for terminals that support them
set -g focus-events on

# Super useful when using "grouped sessions" and multi-monitor setup
setw -g aggressive-resize on

##### Remote / nested TMUX sessions
# Taken from https://github.com/samoshkin/tmux-config/blob/master/tmux/tmux.conf

# Session is considered to be remote when we ssh into host
if-shell 'test -n "$SSH_CLIENT"' \
    'source-file ~/.tmux/tmux.remote.conf'

# We want to have single prefix key "C-a", usable both for local and remote session
# we don't want to "C-a" + "a" approach either
# Idea is to turn off all key bindings and prefix handling on local session,
# so that all keystrokes are passed to inner/remote session

# see: toggle on/off all keybindings · Issue #237 · tmux/tmux - https://github.com/tmux/tmux/issues/237

# Also, change some visual styles when window keys are off
colour_fg=colour240
colour_bg=default
bind -T root F12  \
    set prefix None \;\
    set key-table off \;\
    set status off \;\
    if -F '#{pane_in_mode}' 'send-keys -X cancel' \;\
    refresh-client -S

bind -T off F12 \
  set -u prefix \;\
  set -u key-table \;\
  set status on\;\
  refresh-client -S

# Initialize the plugins (MUST STAY AT THE BOTTOM)
run "~/.tmux/plugins/tpm/tpm"

