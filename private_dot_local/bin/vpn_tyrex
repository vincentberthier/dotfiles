#!/usr/bin/env bash

doas cp /etc/resolv.conf /etc/resolv.conf.pre-vpn
doas /usr/bin/openconnect --background --protocol=gp vpnssl.prtelecom.net --user=vincent.berthier@kub-cleaner.com

until ping -c1 10.103.4.1 > /dev/null 2>&1; do :; done &
trap "kill " SIGINT
wait           # Wait for the loop to exit, one way or another
trap - SIGINT    # Remove the trap, now we're done with it

echo "Clamping MSS to MTU 1360"
doas /usr/bin/ip link set dev tun0 up
doas /usr/bin/ip link set dev tun0 mtu 1360
doas /usr/bin/ip route flush cache
doas /usr/bin/iptables -t mangle -A FORWARD -p tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
